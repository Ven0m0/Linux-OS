name: Copilot Enhanced Context
on:
  workflow_dispatch:
  push:
    branches: [main, master]
    paths:
      - .github/workflows/copilot-setup-steps.yml
      - package*.json
      - bun.lockb
      - .tool-versions
      - .nvmrc
      - "**.sh"
      - "**.yml"
      - "**.yaml"
      - "**.md"
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml
      - package*.json
      - bun.lockb

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  enhanced-context:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 50
          lfs: false

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lockb') }}
          restore-keys: ${{ runner.os }}-bun-

      - name: Install deps
        run: bun install --frozen-lockfile --no-progress
        env:
          NODE_ENV: production

      - name: Install tools
        run: |
          bun add -g prettier eslint typescript
          curl -fsSL https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -o /usr/local/bin/yq
          chmod +x /usr/local/bin/yq

      - name: Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install linters
        run: |
          uv tool install yamllint
          uv tool install shellcheck-py

      - name: Analyze repository structure
        run: |
          {
            echo "# Repository Map"
            echo "Generated: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo
            echo "## Directory Structure"
            echo '```'
            tree -L 3 -I 'node_modules|.git|dist|build|coverage' --dirsfirst || find . -type d -not -path '*/.*' -not -path '*/node_modules/*' | head -50
            echo '```'
            echo
            echo "## File Counts"
            echo "- Shell scripts: $(find . -name '*.sh' -type f | wc -l)"
            echo "- YAML configs: $(find . -name '*.yml' -o -name '*.yaml' -type f | wc -l)"
            echo "- Markdown docs: $(find . -name '*.md' -type f | wc -l)"
            echo "- JavaScript/TS: $(find . -name '*.js' -o -name '*.ts' -o -name '*.jsx' -o -name '*.tsx' -type f | wc -l)"
            echo
          } > .copilot/repo-structure.md

      - name: Extract shell patterns
        if: hashFiles('**/*.sh') != ''
        run: |
          {
            echo "# Shell Function Index"
            echo
            mapfile -t scripts < <(find . -name '*.sh' -type f)
            for script in "${scripts[@]}"; do
              echo "## ${script#./}"
              grep -E '^[a-zA-Z_][a-zA-Z0-9_]*\(\)' "$script" | sed 's/().*//' | sed 's/^/- /' || true
            done
            echo
            echo "## Common Patterns Detected"
            grep -rh 'set -[euo]*' --include='*.sh' . | sort -u | sed 's/^/- /'
            echo
            echo "## Tools Used"
            grep -roh '\b(fd|fdfind|rg|sd|jaq|jq|choose|sk|fzf|aria2|curl|wget)\b' --include='*.sh' . | sort -u | sed 's/^/- /'
          } > .copilot/shell-patterns.md 2>/dev/null || echo "No shell scripts analyzed"

      - name: Map dependencies
        if: hashFiles('package.json', 'bun.lockb') != ''
        run: |
          {
            echo "# Dependency Graph"
            echo
            echo "## Production Dependencies"
            bun pm ls --depth=0 2>/dev/null | grep -v '├─\|└─' || jq -r '.dependencies | keys[]' package.json 2>/dev/null | sed 's/^/- /'
            echo
            echo "## Dev Dependencies"
            jq -r '.devDependencies | keys[]' package.json 2>/dev/null | sed 's/^/- /' || echo "None"
            echo
            echo "## Scripts Available"
            jq -r '.scripts | to_entries[] | "- `\(.key)`: \(.value)"' package.json 2>/dev/null || echo "None"
          } > .copilot/dependencies.md

      - name: Extract TODOs and FIXMEs
        run: |
          {
            echo "# Action Items"
            echo
            echo "## TODO"
            grep -rn 'TODO\|@todo' --include='*.sh' --include='*.js' --include='*.ts' --include='*.md' . 2>/dev/null | sed 's/:/ | Line /' | head -20 || echo "None found"
            echo
            echo "## FIXME"
            grep -rn 'FIXME\|@fixme' --include='*.sh' --include='*.js' --include='*.ts' --include='*.md' . 2>/dev/null | sed 's/:/ | Line /' | head -20 || echo "None found"
            echo
            echo "## HACK"
            grep -rn 'HACK\|@hack' --include='*.sh' --include='*.js' --include='*.ts' . 2>/dev/null | sed 's/:/ | Line /' | head -10 || echo "None found"
          } > .copilot/action-items.md

      - name: Analyze recent changes
        run: |
          {
            echo "# Recent Activity"
            echo
            echo "## Last 10 Commits"
            git log --oneline -10 --no-decorate
            echo
            echo "## Recently Modified Files"
            git diff --name-status HEAD~10..HEAD 2>/dev/null | head -20 || echo "Insufficient history"
            echo
            echo "## Hot Files (most commits)"
            git log --name-only --pretty=format: HEAD~50..HEAD 2>/dev/null | sort | uniq -c | sort -rn | head -10 | awk '{print "- " $2 " (" $1 " changes)"}'
            echo
            echo "## Contributors (last 50 commits)"
            git log --format='%an' -50 | sort | uniq -c | sort -rn | awk '{print "- " $2 " (" $1 " commits)"}'
          } > .copilot/recent-activity.md

      - name: Create quick reference
        run: |
          {
            echo "# Quick Reference"
            echo
            echo "## Environment"
            echo "- OS Target: Arch Linux / Debian"
            echo "- Display: Wayland"
            echo "- Shell: bash $(bash --version | head -1)"
            echo "- Runtime: Bun $(bun --version)"
            echo "- Python: uv $(uv --version)"
            echo
            echo "## Preferred Tools"
            echo '```bash'
            echo "# File operations"
            echo "fd / fdfind  # find alternative"
            echo "rg           # grep alternative"
            echo "sd           # sed alternative"
            echo "jaq / jq     # JSON processing"
            echo "choose       # cut/awk alternative"
            echo
            echo "# Fuzzy finding"
            echo "fzf / sk     # interactive selection"
            echo
            echo "# Parallel execution"
            echo "rust-parallel / parallel / xargs -P\$(nproc)"
            echo
            echo "# Network"
            echo "aria2 / curl / wget2 / wget"
            echo
            echo "# Compression"
            echo "zstd / gzip / xz"
            echo '```'
            echo
            echo "## Shell Standards"
            echo '```bash'
            echo "#!/usr/bin/env bash"
            echo "set -euo pipefail"
            echo "shopt -s nullglob globstar"
            echo 'IFS=$'"'"'\n\t'"'"
            echo "export LC_ALL=C LANG=C"
            echo '```'
            echo
            echo "## Code Style"
            echo "- Indent: 2 spaces"
            echo "- Tests: [[ ... ]] (bash-native)"
            echo "- Quotes: Always quote variables"
            echo "- Arrays: mapfile -t arr < <(...)"
            echo "- Regex: [[ \$var =~ pattern ]]"
            echo
            echo "## Validation Commands"
            echo '```bash'
            echo "shellcheck -x -S warning *.sh"
            echo "shfmt -i 2 -ci -d *.sh"
            echo "yamllint ."
            echo "bun run lint"
            echo '```'
          } > .copilot/quick-reference.md

      - name: Generate master context
        run: |
          mkdir -p .copilot
          {
            echo "# Repository Context for GitHub Copilot"
            echo "Last updated: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo "Branch: ${{ github.ref_name }}"
            echo
            cat .copilot/repo-structure.md 2>/dev/null || true
            echo
            cat .copilot/dependencies.md 2>/dev/null || true
            echo
            cat .copilot/shell-patterns.md 2>/dev/null || true
            echo
            cat .copilot/action-items.md 2>/dev/null || true
            echo
            cat .copilot/recent-activity.md 2>/dev/null || true
            echo
            cat .copilot/quick-reference.md 2>/dev/null || true
            echo
            echo "---"
            echo "## Custom Guidelines"
            [[ -f CLAUDE.MD ]] && echo "See CLAUDE.MD for AI assistant conventions"
            [[ -f GEMINI.MD ]] && echo "See GEMINI.MD for alternative AI conventions"
            [[ -f .shellcheckrc ]] && echo "ShellCheck config: .shellcheckrc"
            [[ -f .yamllint.yml ]] && echo "yamllint config: .yamllint.yml"
            [[ -f .prettierrc.yml ]] && echo "Prettier config: .prettierrc.yml"
          } > copilot-context.md

      - name: Validate generated context
        run: |
          echo "Context size: $(wc -c < copilot-context.md) bytes"
          echo "Lines: $(wc -l < copilot-context.md)"
          head -50 copilot-context.md

      - name: Upload full context
        uses: actions/upload-artifact@v5
        with:
          name: copilot-enhanced-context
          path: |
            copilot-context.md
            .copilot/*.md
          retention-days: 30

      - name: Commit context to repo
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add copilot-context.md .copilot/*.md 2>/dev/null || true
          git diff --staged --quiet || git commit -m "docs: update Copilot context [skip ci]"
          git push || echo "Nothing to commit"

      - name: Summary
        run: |
          cat copilot-context.md >> "$GITHUB_STEP_SUMMARY"
          echo "✓ Enhanced context generated and available for Copilot agents" >> "$GITHUB_STEP_SUMMARY"
