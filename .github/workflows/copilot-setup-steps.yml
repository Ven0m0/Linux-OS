name: Copilot Setup & Validation
on:
  workflow_dispatch:
  push:
    branches: [main, master]
    paths:
      - .github/workflows/copilot-setup-steps.yml
      - package*.json
      - bun.lockb
      - .tool-versions
      - .nvmrc
      - "**.sh"
      - "**.yml"
      - "**.yaml"
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml
      - package*.json
      - bun.lockb

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  setup-validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          lfs: false

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun modules
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lockb') }}
          restore-keys: ${{ runner.os }}-bun-

      - name: Install deps
        run: bun install --frozen-lockfile --no-progress
        env:
          NODE_ENV: production

      - name: Install global tools
        run: bun add -g prettier eslint typescript

      - name: Setup uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: "**/.megalinter.yml"

      - name: Install Python linters
        run: |
          uv tool install yamllint
          uv tool install shellcheck-py

      - name: Validate shell scripts
        if: hashFiles('**/*.sh') != ''
        run: |
          mapfile -t scripts < <(fd -e sh -t f)
          ((${#scripts[@]})) && shellcheck -x -S warning "${scripts[@]}" || echo "No shell scripts"

      - name: Validate YAML
        if: hashFiles('**/*.yml', '**/*.yaml') != ''
        run: |
          mapfile -t yamls < <(fd -e yml -e yaml -t f)
          ((${#yamls[@]})) && yamllint -f parsable "${yamls[@]}" || echo "No YAML files"

      - name: Format check
        if: hashFiles('.prettierrc.yml', '.prettierrc') != ''
        run: bun x prettier --check . || true

      - name: Generate Copilot context
        run: |
          {
            echo "# Repository Context"
            echo "Runtime: Bun $(bun --version) | Node $(node --version)"
            echo "Python: uv $(uv --version)"
            echo
            echo "## Tooling"
            echo "- Package manager: Bun (lockfile: bun.lockb)"
            echo "- Python tools: uv (replaces pip/pipx)"
            echo "- Linters: ShellCheck, yamllint, Prettier, ESLint"
            echo "- Shell target: bash (Arch/Debian, Wayland)"
            echo
            echo "## Standards"
            echo "- Indent: 2 spaces"
            echo "- Shell: set -euo pipefail; prefer fd/rg/sd/jaq"
            echo "- Validation: shellcheck clean, shfmt -i 2 -ci"
            [[ -f CLAUDE.MD ]] && echo "- Custom guide: CLAUDE.MD"
            [[ -f GEMINI.MD ]] && echo "- Custom guide: GEMINI.MD"
            echo
            echo "## Quick checks"
            echo '```bash'
            echo "bun install && bun run lint"
            echo "fd -e sh -x shellcheck -x -S warning"
            echo "yamllint ."
            echo '```'
          } > copilot-context.md

      - name: Upload context
        uses: actions/upload-artifact@v4
        with:
          name: copilot-context
          path: copilot-context.md
          retention-days: 7

      - name: Setup summary
        run: |
          cat copilot-context.md >> "$GITHUB_STEP_SUMMARY"
          echo "âœ“ Environment validated and ready for Copilot" >> "$GITHUB_STEP_SUMMARY"
