# ~/.github/workflows/dependabot-automation.yml
#
# GitHub Actions workflow to automate Dependabot PR management.
# 1. Combines multiple Dependabot PRs into a single PR.
# 2. Auto-merges Dependabot PRs when they are mergeable (CI pass, etc).

name: Dependabot Automation

on:
  # Run on pull requests, specifically targeting Dependabot branches
  pull_request_target:
    types:
      - opened
      - synchronize
      - reopened

# Grant necessary permissions for the jobs.
# Both actions require write access to pull requests and contents.
permissions:
  pull-requests: write
  contents: write

jobs:
  # This job combines multiple open Dependabot PRs into one.
  combine:
    name: Combine Dependabot PRs
    # Run only for PRs created by Dependabot.
    if: github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Combine Dependabot PRs
        uses: mAAdhaTTah/combine-dependabot-prs@v4
        with:
          # The GITHUB_TOKEN is automatically provided by GitHub Actions.
          # The token's permissions are configured at the top level.
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # Do not combine major version updates as they often contain breaking changes.
          exclude-major-versions: true
          # Combine up to 10 PRs at once.
          branch-pr-limit: 10
          # Auto-approve the combined PR
          approve: true

  # This job automatically merges a Dependabot PR if it's ready.
  # It works on both individual PRs and the combined PR from the 'combine' job.
  automerge:
    name: Auto-merge Dependabot PRs
    # Run only for PRs created by Dependabot.
    if: github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Auto-merge Dependabot PR
        uses: fastify/github-action-merge-dependabot@v3
        with:
          # The GITHUB_TOKEN is automatically provided.
          github-token: ${{ secrets.GITHUB_TOKEN }}
          # Merge only after all status checks have passed.
          merge-when-checks-succeed: 'all'
          # Use squash and merge commit strategy.
          merge-method: 'squash'
