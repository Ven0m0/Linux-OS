# Rust Optimization Flags Reference

## Profile Configuration for PGO/BOLT

### Enable profiling mode
```bash
profileon() {
  sudo sh -c "echo 0 > /proc/sys/kernel/randomize_va_space"
  sudo sh -c "echo 0 > /proc/sys/kernel/nmi_watchdog"
  sudo sh -c "echo 1 > /sys/devices/system/cpu/intel_pstate/no_turbo"
  sudo sh -c "echo 0 > /proc/sys/kernel/kptr_restrict"
  sudo sh -c "echo 0 > /proc/sys/kernel/perf_event_paranoid"
  sudo cpupower frequency-set --governor performance
}

profileoff() {
  sudo sh -c "echo 1 > /proc/sys/kernel/randomize_va_space"
  sudo sh -c "echo 0 > /sys/devices/system/cpu/intel_pstate/no_turbo"
}
```

## Cargo Profile Configuration

### Optimized release profile (Cargo.toml)
```toml
[profile.release]
strip = "symbols"
split-debuginfo = "packed"
debug = false
codegen-units = 1
incremental = false
lto = "fat"
panic = "abort"
opt-level = "3"
debug-assertions = false
overflow-checks = false
```

## Advanced RUSTFLAGS

### Base optimization flags
```bash
-Copt-level=3
-Ctarget-cpu=native
-Ccodegen-units=1
-Clto=fat
-Clinker-plugin-lto
-Ztune-cpu=native
-Cstrip=symbols
-Cpanic=abort
```

### Experimental unstable flags
```bash
-Zunstable-options
-Zfewer-names
-Zcombine-cgu
-Zmerge-functions=aliases
-Zvirtual-function-elimination
-Zno-embed-metadata
-Zfunction-sections
-Zlocation-detail=none
-Zfmt-debug=none
-Zprecise-enum-drop-elaboration=yes
-Zdefault-visibility=hidden
```

### Build std with optimizations
```bash
-Zbuild-std=std,panic_abort
-Zbuild-std-features=panic_immediate_abort
```

### PGO-specific flags (2nd compilation)
```bash
-Cprofile-use=./default.profdata
-Cprofile-correction
-Cllvm-args=-pgo-warn-missing-function
```

### BOLT preparation
```bash
-Clink-args=-Wl,--emit-relocs
```

## LLVM Args

### Jump threading and vectorization
```bash
-Cllvm-args=-enable-dfa-jump-thread
-Cllvm-args=-loop-vectorize
-Cllvm-args=-slp-vectorize
```

### Polly optimization (experimental)
```bash
-Cllvm-args=-polly
-Cllvm-args=-polly-vectorizer=polly
-Cllvm-args=-polly-tiling
```

## Link Flags

### For mold linker
```bash
-Clink-arg=-fuse-ld=mold
```

### For lld linker
```bash
-Clink-arg=-fuse-ld=lld
```

### Advanced link optimizations
```bash
-Clink-arg=-Wl,-O3
-Clink-arg=-Wl,-gc-sections
-Clink-arg=-Wl,--icf=all
-Clink-arg=-Wl,--lto-O3
-Clink-arg=-Wl,-z,now
-Clink-arg=-Wl,-z,relro
-Clink-arg=-Wl,-z,pack-relative-relocs
```

## C/C++ Flags

### CFLAGS
```bash
export CFLAGS="-march=native -mtune=native -O3 -pipe -fno-plt -Wno-error \
  -fno-semantic-interposition -fdata-sections -ffunction-sections -ftree-vectorize \
  -fomit-frame-pointer -fvisibility=hidden -fmerge-all-constants -finline-functions \
  -fjump-tables -pthread -fshort-enums -fshort-wchar -feliminate-unused-debug-types \
  -feliminate-unused-debug-symbols"
```

### CXXFLAGS
```bash
export CXXFLAGS="$CFLAGS -fsized-deallocation -fstrict-vtable-pointers"
```

### LDFLAGS
```bash
export LDFLAGS="-Wl,-O3 -Wl,--sort-common -Wl,--as-needed -Wl,-z,relro -Wl,-z,now \
  -Wl,-z,pack-relative-relocs -Wl,-gc-sections -Wl,--compress-relocations \
  -Wl,--discard-locals -Wl,--strip-all -Wl,--icf=all"
```

## PGO Workflow

### 1. Build instrumented binary
```bash
export RUSTFLAGS="-Cprofile-generate=./pgo_data -Cembed-bitcode=yes <other flags>"
cargo build --release
```

### 2. Run workload to collect profiles
```bash
./target/release/binary <typical workload>
# OR use perf for sampling-based profiling
perf record -e cycles:u -j any,u -- ./target/release/binary <args>
```

### 3. Merge profiles
```bash
llvm-profdata merge -output=default.profdata ./pgo_data
```

### 4. Build optimized binary
```bash
export RUSTFLAGS="-Cprofile-use=./default.profdata -Cprofile-correction <other flags>"
cargo build --release
```

## BOLT Workflow

### 1. Build with relocs for BOLT
```bash
export RUSTFLAGS="-Clink-args=-Wl,--emit-relocs <other pgo flags>"
cargo pgo build
```

### 2. Instrument for BOLT
```bash
cargo pgo bolt build --with-pgo
```

### 3. Run instrumented binary
```bash
./target/release/<binary>-bolt-instrumented <workload>
```

### 4. Optimize with BOLT
```bash
cargo pgo bolt optimize --with-pgo
```

### BOLT options (manual)
```bash
llvm-bolt <binary> -o <binary>.bolt \
  --data=<profile> \
  --reorder-blocks=ext-tsp \
  --reorder-functions=hfsort+ \
  --split-functions \
  --split-all-cold \
  --split-eh \
  --icf=all \
  --dyno-stat \
  --use-gnu-stack \
  --peepholes=all
```

## Environment Variables

### Cargo
```bash
export CARGO_INCREMENTAL=0
export RUSTC_BOOTSTRAP=1
export CARGO_PROFILE_RELEASE_LTO=true
export CARGO_BUILD_JOBS=$(nproc)
export CARGO_CACHE_RUSTC_INFO=1
export CARGO_HTTP_MULTIPLEXING=true
export CARGO_NET_GIT_FETCH_WITH_CLI=true
export CARGO_CACHE_AUTO_CLEAN_FREQUENCY=always
```

### Compiler toolchain
```bash
export CC=clang
export CXX=clang++
export AR=llvm-ar
export NM=llvm-nm
export RANLIB=llvm-ranlib
export STRIP=llvm-strip
```

### With sccache
```bash
export CC="sccache clang"
export CXX="sccache clang++"
export RUSTC_WRAPPER=sccache
```

### Memory allocator (jemalloc)
```bash
export MALLOC_CONF="thp:always,metadata_thp:always,tcache:true,percpu_arena:percpu"
export _RJEM_MALLOC_CONF="$MALLOC_CONF"
echo always | sudo tee /sys/kernel/mm/transparent_hugepage/enabled
```

## Useful Cargo Commands

### Maintenance
```bash
cargo update --recursive
cargo fix --workspace --all-targets --allow-dirty -r
cargo clippy --fix --workspace --allow-dirty
cargo fmt --all
cargo-cache -g -f -e clean-unref
```

### Dependency cleanup
```bash
cargo +nightly udeps --workspace --release --all-features
cargo-shear --fix
cargo-machete --fix
cargo-machete --fix --with-metadata
```

### Fast install snippet
```bash
cargo-fast-install() {
  RUSTUP_TOOLCHAIN=nightly \
  RUSTC_BOOTSTRAP=1 \
  RUSTFLAGS="-Copt-level=3 -Ctarget-cpu=native -Clto=thin -Ccodegen-units=1" \
  cargo install "$@"
}
```

## Useful Projects

### Dotfile managers
- https://github.com/RaphGL/Tuckr
- https://github.com/levinion/stor
- https://github.com/SuperCuber/dotter
- https://github.com/oknozor/toml-bombadil
- https://github.com/comtrya/comtrya

### Utilities
- https://github.com/644/compressimages
- https://github.com/jkool702/forkrun
- https://crates.io/crates/trees-rs
