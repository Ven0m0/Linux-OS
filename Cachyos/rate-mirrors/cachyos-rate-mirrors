#!/usr/bin/env bash
# shellcheck enable=all shell=bash source-path=SCRIPTDIR
# Copyright (C) 2022-2025 CachyOS team
# Multi-repo mirror ranking with archlinux.org API integration
set -euo pipefail; shopt -s nullglob globstar
IFS=$'\n\t' LC_ALL=C

has(){ command -v -- "$1" &>/dev/null; }
die(){ printf '%s\n' "$1" >&2; exit "${2:-1}"; }

readonly MIRRORS_DIR="/etc/pacman.d" TMPFILE="$(mktemp)"
trap 'rm -f -- "$TMPFILE"' EXIT

declare COUNTRY="${COUNTRY:-}" ALL_OFF BOLD RED GREEN YELLOW
declare -a REPOS_TO_RATE=()
declare -rA REPO_META=(
    [arch]="arch|${MIRRORS_DIR}/mirrorlist|0|arch_special"
    [cachyos]="cachyos|${MIRRORS_DIR}/cachyos-mirrorlist|1|cachyos_special"
    [alhp]="alhp|${MIRRORS_DIR}/alhp-mirrorlist|0|"
    [chaotic]="chaotic|${MIRRORS_DIR}/chaotic-mirrorlist|0|"
)

if [[ -t 2 ]] && tput setaf 0 &>/dev/null; then
    ALL_OFF="$(tput sgr0)" BOLD="$(tput bold)"
    RED="${BOLD}$(tput setaf 1)" GREEN="${BOLD}$(tput setaf 2)" YELLOW="${BOLD}$(tput setaf 3)"
else
    ALL_OFF=$'\e[0m' BOLD=$'\e[1m' RED=$'\e[1;31m' GREEN=$'\e[1;32m' YELLOW=$'\e[1;33m'
fi
readonly ALL_OFF BOLD RED GREEN YELLOW

msg_info(){ printf "%s==>%s%s %s%s\n" "$GREEN" "$ALL_OFF" "$BOLD" "$1" "$ALL_OFF" >&2; }
msg_warn(){ printf "%s -->%s%s %s%s\n" "$YELLOW" "$ALL_OFF" "$BOLD" "$1" "$ALL_OFF" >&2; }
msg_err(){ printf "%s==> ERROR:%s%s %s%s\n" "$RED" "$ALL_OFF" "$BOLD" "$1" "$ALL_OFF" >&2; }

usage(){
    cat >&2 <<EOF
${BOLD}cachyos-rate-mirrors${ALL_OFF}
Usage: $0 [OPTIONS]

OPTIONS:
  --repos REPO[,REPO...]  Comma-separated repos (arch,cachyos,alhp,chaotic)
                         Default: all repos
  --country CC            Override country code (auto-detectâ†’DE fallback)
  -h, --help             Show this help

EXAMPLES:
  $0                           # All repos, auto-country
  $0 --repos arch,cachyos      # Specific repos
  $0 --country FR --repos arch # Override country
EOF
    exit "${1:-0}"
}

parse_args(){
    while (($#)); do
        case "$1" in
            --repos) IFS=',' read -ra REPOS_TO_RATE <<<"${2}"; shift 2 ;;
            --country) COUNTRY="$2"; shift 2 ;;
            -h|--help) usage 0 ;;
            *) die "Unknown: $1" 1 ;;
        esac
    done
    [[ ${#REPOS_TO_RATE[@]} -eq 0 ]] && REPOS_TO_RATE=(arch cachyos alhp chaotic)
    for r in "${REPOS_TO_RATE[@]}"; do
        [[ -v "REPO_META[$r]" ]] || die "Unknown repo: $r" 1
    done
}

detect_country(){
    [[ -n "$COUNTRY" ]] && return
    local raw
    raw=$(curl --connect-timeout 10 -sSL 'https://geoip.kde.org/v1/ubiquity' 2>/dev/null || true)
    COUNTRY="${raw#*<CountryCode>}" COUNTRY="${COUNTRY%%</CountryCode>*}" COUNTRY="${COUNTRY^^}"
    [[ ${#COUNTRY} -eq 2 ]] || COUNTRY="DE"
    msg_info "Detected country: $COUNTRY"
}

fetch_arch_mirrors(){
    msg_warn "Fetching arch mirrors (archlinux.org: country=$COUNTRY, HTTPS, IPv4)..."
    curl -sSL "https://archlinux.org/mirrorlist/?country=${COUNTRY}&protocol=https&ip_version=4" 2>/dev/null |
        sed -n 's/^#Server/Server/p' >"$TMPFILE" || die "Arch mirror fetch failed" 1
}

rate_mirrors(){
    local repo="$1" path="$2"
    msg_warn "Ranking $repo mirrors..."
    rate-mirrors --save "$TMPFILE" "$repo" &>/dev/null || die "rate-mirrors[$repo] failed" 1
    [[ -f "$path" ]] || die "$path missing" 1
    cp -f --backup=simple --suffix="-backup" "$TMPFILE" "$path"
    msg_info "Done [$repo] $path"
}

arch_special(){
    [[ "$COUNTRY" == "RU" ]] || return 0
    sed -i '1iServer = https://mirror.yandex.ru/archlinux/$repo/os/$arch' "$1"
}

cachyos_special(){
    if [[ "$COUNTRY" != "RU" ]]; then
        sed -i '1iServer = https://archlinux.cachyos.org/repo/$repo/os/$arch' "$1"
    else
        sed -i '1iServer = https://archlinux.gay/cachy/repo/$arch/$repo\nServer = https://mirror.yandex.ru/cachyos/repo/$arch/$repo' "$1"
    fi
}

create_variants(){
    local base="$1" v3="${1%-*}-v3-mirrorlist" v4="${1%-*}-v4-mirrorlist"
    cp -f --backup=simple --suffix="-backup" "$base" "$v3"
    cp -f --backup=simple --suffix="-backup" "$base" "$v4"
    sed -i 's|/$arch/|/$arch_v3/|g' "$v3"
    sed -i 's|/$arch/|/$arch_v4/|g' "$v4"
}

process_repo(){
    local repo="$1" meta="${REPO_META[$1]}" path handler needs_v
    IFS='|' read -r _ path needs_v handler <<<"$meta"
    
    if [[ "$repo" == "arch" ]]; then
        fetch_arch_mirrors
    else
        export RATE_MIRRORS_ENTRY_COUNTRY="$COUNTRY"
        rate_mirrors "$repo" "$path"
    fi
    
    [[ -n "$handler" ]] && "$handler" "$path"
    ((needs_v)) && create_variants "$path"
    chmod go+r "${MIRRORS_DIR}"/*mirrorlist* 2>/dev/null || true
}

main(){
    [[ $EUID -eq 0 ]] || die "Root required" 1
    
    export RATE_MIRRORS_PROTOCOL=https RATE_MIRRORS_ALLOW_ROOT=true
    export RATE_MIRRORS_FETCH_MIRRORS_TIMEOUT="${RATE_MIRRORS_FETCH_MIRRORS_TIMEOUT:-30000}"
    export RATE_MIRRORS_MAX_DELAY="${RATE_MIRRORS_MAX_DELAY:-10000}"
    
    parse_args "$@"
    detect_country
    
    msg_info "Processing: ${REPOS_TO_RATE[*]}"
    for r in "${REPOS_TO_RATE[@]}"; do process_repo "$r"; done
    msg_info "Mirror ranking complete"
}

main "$@"
